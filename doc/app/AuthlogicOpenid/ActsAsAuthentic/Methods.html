<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8">

<title>module AuthlogicOpenid::ActsAsAuthentic::Methods - Rails Application Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
</script>

<script src="../../js/jquery.js"></script>
<script src="../../js/darkfish.js"></script>

<link href="../../css/fonts.css" rel="stylesheet">
<link href="../../css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="module">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../table_of_contents.html#pages">Pages</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    
    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-c-included">::included</a>
    
    <li ><a href="#method-i-attributes_to_save">#attributes_to_save</a>
    
    <li ><a href="#method-i-map_openid_registration">#map_openid_registration</a>
    
    <li ><a href="#method-i-map_saved_attributes">#map_saved_attributes</a>
    
    <li ><a href="#method-i-openid_identifier-3D">#openid_identifier=</a>
    
    <li class="calls-super" ><a href="#method-i-save">#save</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="module-AuthlogicOpenid::ActsAsAuthentic::Methods">
  <h1 id="module-AuthlogicOpenid::ActsAsAuthentic::Methods" class="module">
    module AuthlogicOpenid::ActsAsAuthentic::Methods
  </h1>

  <section class="description">
    
  </section>

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

    
      <div id="method-c-included" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">included</span><span
            class="method-args">(klass)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Set up some simple validations</p>
          
          

          
          <div class="method-source-code" id="included-source">
            <pre><span class="ruby-comment"># File lib/authlogic_openid/authlogic_openid/acts_as_authentic.rb, line 42</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">included</span>(<span class="ruby-identifier">klass</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">klass</span>.<span class="ruby-identifier">column_names</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;openid_identifier&quot;</span>)
  
  <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">class_eval</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">validates_uniqueness_of</span> <span class="ruby-value">:openid_identifier</span>, <span class="ruby-value">:scope</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">validations_scope</span>, <span class="ruby-value">:if</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:using_openid?</span>
    <span class="ruby-identifier">validate</span> <span class="ruby-value">:validate_openid</span>
    <span class="ruby-identifier">validates_length_of_password_field_options</span> <span class="ruby-identifier">validates_length_of_password_field_options</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-value">:if</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:validate_password_with_openid?</span>)
    <span class="ruby-identifier">validates_confirmation_of_password_field_options</span> <span class="ruby-identifier">validates_confirmation_of_password_field_options</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-value">:if</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:validate_password_with_openid?</span>)
    <span class="ruby-identifier">validates_length_of_password_confirmation_field_options</span> <span class="ruby-identifier">validates_length_of_password_confirmation_field_options</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-value">:if</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:validate_password_with_openid?</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-openid_identifier-3D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">openid_identifier=</span><span
            class="method-args">(value)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Set the openid_identifier field and also resets the persistence_token if
this value changes.</p>
          
          

          
          <div class="method-source-code" id="openid_identifier-3D-source">
            <pre><span class="ruby-comment"># File lib/authlogic_openid/authlogic_openid/acts_as_authentic.rb, line 55</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">openid_identifier=</span>(<span class="ruby-identifier">value</span>)
  <span class="ruby-identifier">write_attribute</span>(<span class="ruby-value">:openid_identifier</span>, <span class="ruby-identifier">value</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">:</span> <span class="ruby-constant">OpenID</span>.<span class="ruby-identifier">normalize_url</span>(<span class="ruby-identifier">value</span>))
  <span class="ruby-identifier">reset_persistence_token</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">openid_identifier_changed?</span>
<span class="ruby-keyword">rescue</span> <span class="ruby-constant">OpenID</span><span class="ruby-operator">::</span><span class="ruby-constant">DiscoveryFailure</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
  <span class="ruby-ivar">@openid_error</span> = <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-save" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">save</span><span
            class="method-args">(perform_validation = true) { |result| ... }</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>This is where all of the magic happens. This is where we hook in and add
all of the OpenID sweetness.</p>

<p>I had to take this approach because when authenticating with OpenID nonces
and what not are stored in database tables. That being said, the whole save
process for <a href="../../ActiveRecord.html">ActiveRecord</a> is wrapped
in a transaction. Trying to authenticate with OpenID in a transaction is
not good because that transaction be get rolled back, thus reversing all of
the OpenID inserts and making OpenID authentication fail every time. So We
need to step outside of the transaction and do our OpenID madness.</p>

<p>Another advantage of taking this approach is that we can set fields from
their OpenID profile before we save the record, if their OpenID provider
supports it.</p>
          
          
            <div class="method-calls-super">
              Calls superclass method
              
            </div>
          

          
          <div class="method-source-code" id="save-source">
            <pre><span class="ruby-comment"># File lib/authlogic_openid/authlogic_openid/acts_as_authentic.rb, line 72</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">save</span>(<span class="ruby-identifier">perform_validation</span> = <span class="ruby-keyword">true</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">perform_validation</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">block_given?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">authenticate_with_openid?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">authenticate_with_openid</span>
  <span class="ruby-identifier">result</span> = <span class="ruby-keyword">super</span>
  <span class="ruby-keyword">yield</span>(<span class="ruby-identifier">result</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">block_given?</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
     <section id="private-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Private Instance Methods</h3>
       </header>

    
      <div id="method-i-attributes_to_save" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">attributes_to_save</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>This method works in conjunction with map_saved_attributes.</p>

<p>Let&#39;s say a user fills out a registration form, provides an OpenID and
submits the form. They are then redirected to their OpenID provider. All is
good and they are redirected back. All of those fields they spent time
filling out are forgetten and they have to retype them all. To avoid this,
<a href="../../AuthlogicOpenid.html">AuthlogicOpenid</a> saves all of these
attributes in the session and then attempts to restore them. See the source
for what attributes it saves. If you need to block more attributes, or save
more just override this method and do whatever you want.</p>
          
          

          
          <div class="method-source-code" id="attributes_to_save-source">
            <pre><span class="ruby-comment"># File lib/authlogic_openid/authlogic_openid/acts_as_authentic.rb, line 133</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">attributes_to_save</span> <span class="ruby-comment"># :doc:</span>
  <span class="ruby-identifier">attrs_to_save</span> = <span class="ruby-identifier">attributes</span>.<span class="ruby-identifier">clone</span>.<span class="ruby-identifier">delete_if</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
    [<span class="ruby-value">:id</span>, <span class="ruby-value">:password</span>, <span class="ruby-identifier">crypted_password_field</span>, <span class="ruby-identifier">password_salt_field</span>, <span class="ruby-value">:persistence_token</span>, <span class="ruby-value">:perishable_token</span>, <span class="ruby-value">:single_access_token</span>, <span class="ruby-value">:login_count</span>, 
      <span class="ruby-value">:failed_login_count</span>, <span class="ruby-value">:last_request_at</span>, <span class="ruby-value">:current_login_at</span>, <span class="ruby-value">:last_login_at</span>, <span class="ruby-value">:current_login_ip</span>, <span class="ruby-value">:last_login_ip</span>, <span class="ruby-value">:created_at</span>,
      <span class="ruby-value">:updated_at</span>, <span class="ruby-value">:lock_version</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_sym</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">attrs_to_save</span>.<span class="ruby-identifier">merge!</span>(<span class="ruby-value">:password</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">password</span>, <span class="ruby-value">:password_confirmation</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">password_confirmation</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-map_openid_registration" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">map_openid_registration</span><span
            class="method-args">(registration)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Override this method to map the OpenID registration fields with fields in
your model. See the required_fields and optional_fields configuration
options to enable this feature.</p>

<p>Basically you will get a hash of values passed as a single argument. Then
just map them as you see fit. Check out the source of this method for an
example.</p>
          
          

          
          <div class="method-source-code" id="map_openid_registration-source">
            <pre><span class="ruby-comment"># File lib/authlogic_openid/authlogic_openid/acts_as_authentic.rb, line 120</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">map_openid_registration</span>(<span class="ruby-identifier">registration</span>) <span class="ruby-comment"># :doc:</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">registration</span>[<span class="ruby-value">:fullname</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:name</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">registration</span>[<span class="ruby-value">:fullname</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">first_name</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">registration</span>[<span class="ruby-value">:fullname</span>].<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot; &quot;</span>).<span class="ruby-identifier">first</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:first_name</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">registration</span>[<span class="ruby-value">:fullname</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">last_name</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">registration</span>[<span class="ruby-value">:fullname</span>].<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot; &quot;</span>).<span class="ruby-identifier">last</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:last_name</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">registration</span>[<span class="ruby-value">:last_name</span>].<span class="ruby-identifier">blank?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-map_saved_attributes" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">map_saved_attributes</span><span
            class="method-args">(attrs)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>This method works in conjunction with attributes_to_save. See that method
for a description of the why these methods exist.</p>

<p>If the default behavior of this method is not sufficient for you because
you have attr_protected or attr_accessible then override this method and
set them individually. Maybe something like this would be good:</p>

<pre class="ruby"><span class="ruby-identifier">attrs</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;#{key}=&quot;</span>, <span class="ruby-identifier">value</span>)
<span class="ruby-keyword">end</span>
</pre>
          
          

          
          <div class="method-source-code" id="map_saved_attributes-source">
            <pre><span class="ruby-comment"># File lib/authlogic_openid/authlogic_openid/acts_as_authentic.rb, line 150</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">map_saved_attributes</span>(<span class="ruby-identifier">attrs</span>) <span class="ruby-comment"># :doc:</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">attributes</span> = <span class="ruby-identifier">attrs</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://docs.seattlerb.org/rdoc/">RDoc</a> 4.2.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

